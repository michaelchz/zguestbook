# PHP 8.3 兼容性升级计划

## 1. 分析总结

`src` 目录下的 PHP 脚本包含一些与 PHP 8.3 不兼容的旧版特性。主要问题包括：

1.  **短开放标签 (`<?`)**: 在 `authimg.php` 中使用，应替换为 `<?php`。
2.  **旧的超全局变量**: `authimg.php` 使用了 `$HTTP_GET_VARS`，必须替换为 `$_GET`。
3.  **废弃的 POSIX 正则表达式函数**: `gb.php` 中多处使用了 `eregi()` 和 `eregi_replace()`，需要用 `preg_match()` 和 `preg_replace()` 替代。
4.  **废弃的 `split()` 函数**: `gb.php` 的注释中包含 `split()`，应替换为 `explode()`。
5.  **废弃的 `gmstrftime()` 函数**: `setup.php` 使用了 `gmstrftime()`，应使用 `gmdate()` 替代。
6.  **不推荐的 `$GLOBALS` 用法**: `setup.php` 中应直接使用 `$_SERVER` 替代 `$GLOBALS` 来访问服务器变量。
7.  **废弃的 `srand()` 函数**: `authimg.php` 和 `gb.php` 中使用了 `srand()`，在 PHP 7.1 后已不再需要。
8.  **类的 `var` 声明**: `gb.php` 中的类属性使用了 `var` 关键字，应替换为 `public`。
9.  **旧的函数别名**: 代码中使用了如 `Header`, `ImagePNG`, `chop` 等别名，应统一为标准名称 (`header`, `imagepng`, `rtrim`)。

## 2. 分文件修改计划

### 2.1. `src/authimg.php`
- 将 `<?` 替换为 `<?php`。
- 将 `Header(...)` 替换为 `header(...)`。
- 移除 `srand(...)` 这一行。
- 将 `$HTTP_GET_VARS['authcode']` 替换为 `$_GET['authcode']`。
- 将 `ImagePNG($im)` 替换为 `imagepng($im)`。
- 将 `ImageDestroy($im)` 替换为 `imagedestroy($im)`。
- 清理文件末尾的乱码。

### 2.2. `src/gb.php`
- 将类 `CFormMessage` 中的 `var` 声明替换为 `public`。
- 将 `!eregi(...)` 替换为 `!preg_match(...)` 并更新正则表达式。
- 将所有 `eregi_replace(...)` 替换为 `preg_replace(...)` 并更新正则表达式和反向引用。
- 移除 `srand(...)` 这一行。
- 将 `while(($authcode=rand()%10000)<1000);` 优化为 `$authcode = rand(1000, 9999);`。

### 2.3. `src/log.php`
- 将 `chop($line)` 替换为 `rtrim($line)`。

### 2.4. `src/setup.php`
- 将 `$userip=$GLOBALS['REMOTE_ADDR'];` 替换为 `$userip=$_SERVER['REMOTE_ADDR'];`。
- 在 `getlocaltime()` 函数中，将所有 `gmstrftime(...)` 调用替换为等效的 `gmdate(...)` 调用。
- 在 `myurl()` 函数中，将对 `$GLOBALS` 的访问替换为对 `$_SERVER` 的访问。
- 将 `$cgiurl=$PHP_SELF;` 替换为 `$cgiurl=$_SERVER['PHP_SELF'];`。
